---
title: ts-jest ã‹ã‚‰ @swc/jest ã«ç§»è¡Œã—ãŸã¨ãã«ã¤ã¾ã¥ã„ãŸã“ã¨
published: 2025-02-22
description: ts-jest ã‹ã‚‰ @swc/jest ã«ã—ãŸã¨ãã«ã¤ã¾ã¥ã„ãŸã¨ã“ã‚ã®è©±ã§ã™ã€‚
tags: [test, jest]
---

æœ€è¿‘ã€TypeScript ã‚’ä½¿ã£ã¦ã„ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã§ ts-jest ã‹ã‚‰ @swc/jest ã«ç§»è¡Œã™ã‚‹æ©Ÿä¼šãŒã‚ã‚Šã¾ã—ãŸã€‚
ãƒ†ã‚¹ãƒˆã®å®Œäº†ã¾ã§ã ã„ã¶ã‹ã‹ã£ã¦ã„ãŸã®ã§ç§»è¡Œã—ãŸã®ã§ã™ãŒã€ã‹ã‹ã‚‹æ™‚é–“ãŒåŠåˆ†ãã‚‰ã„ã«ãªã£ã¦ãƒãƒƒãƒ”ãƒ¼ã§ã™ã€‚

ãŸã ã€ç§»è¡Œã™ã‚‹éš›ã«ã¤ã¾ã¥ã„ãŸéƒ¨åˆ†ã‚‚ã‚ã£ãŸã®ã§å¾Œã®ä¸–ã®ãŸã‚ã«å…±æœ‰ã—ã¾ã™ã€‚

## ã‚„ã‚‹ã“ã¨

ã¾ãšã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
ä½¿ã£ã¦ã„ã‚‹ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ã«åˆã‚ã›ã¦ã€[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][1]ã«æ›¸ã„ã¦ã‚ã‚‹ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã™ã‚Œã°ã‚ˆã„ã§ã™ã€‚

ãã®å¾Œã€`jest.config.js`ã® transform éƒ¨åˆ†ã« @swc/jest ã‚’æŒ‡å®šã—ã¾ã™ã€‚

```js title="jest.config.js"
module.exports = {
    transform: {
        '^.+\\.tsx?$': '@swc/jest',
    },
}
```

ã‚ã¨ã¯`.swcrc`ã‚’æ›¸ã„ã¦ã ã„ãŸã„ã®è¨­å®šã¯çµ‚ã‚ã‚Šã§ã™ã€‚
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ«ãƒ¼ãƒˆã«`.swcrc`ã‚’ä½œæˆã™ã‚Œã°è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¿ãŸã„ã§ã™ã€‚

ã“ã“ã¾ã§è¨­å®šã—ãŸæ™‚ç‚¹ã§ã€ã»ã¨ã‚“ã©ã®ãƒ†ã‚¹ãƒˆã¯ãã®ã¾ã¾å‹•ãã¾ã—ãŸã€‚

## ã¤ã¾ã¥ã„ãŸã“ã¨

- [@swc/jestã§æ‰‹é–“ã‚’ã‹ã‘ãšã«ãƒ†ã‚¹ãƒˆã‚’æ—©ãã™ã‚‹][2]
- [jest.spyOnã§TypeError: Cannot redefine property][3]

ä¸Šè¨˜ã®è¨˜äº‹ãŒå‚è€ƒã«ãªã‚Šã¾ã™ãŒã€`import * as ~`ã®å½¢ã§ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦`jest.spyOn` ã—ã¦ã„ã‚‹éƒ¨åˆ†ã‚’ä¿®æ­£ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®ã‚ˆã†ã«ã—ã¦ã„ã‚‹ã¨`TypeError: Cannot redefine property`ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚

```ts title="sample.ts"
export const sampleFunc = (message: string) => {
    return `this is ${message}`
}
```

ã“ã®é–¢æ•°ã‚’ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹ã¨ãƒ€ãƒ¡ã€‚

```ts
import * as sample from './sample'

const spied = jest.spyOn(sample, 'sampleFunc') // TypeError: Cannot redefine property
```

ãã®ãŸã‚ã€å€‹åˆ¥ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦`jest.mock`ã—ã¦ã‹ã‚‰`jest.mocked`ã«æ›¸ãæ›ãˆã‚‹ã¨ã‚¨ãƒ©ãƒ¼ãŒå‡ºãªããªã‚Šã¾ã™ã€‚

```ts
import { sampleFunc } from './sample'

jest.mock('./sample') // './sample'ã«å«ã¾ã‚Œã‚‹é–¢æ•°ã‚’ã™ã¹ã¦ãƒ¢ãƒƒã‚¯
const mocked = jest.mocked(sampleFunc) // sampleFuncã‚’ãƒ¢ãƒƒã‚¯é–¢æ•°ã®å‹å®šç¾©ã§ãƒ©ãƒƒãƒ—
```

ã“ã‚Œã§ä¸€å®‰å¿ƒã¨æ€ã„ãã‚„ã€ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¦ã„ã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã—ãŸã€‚
åŸå› ã¯`jest.spyOn`ã¯æ—¢å­˜ã®å®Ÿè£…ãŒãã®ã¾ã¾å‘¼ã°ã‚Œã‚‹ã®ã«å¯¾ã—ã¦ã€`jest.mock`ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã ã¨å®Ÿè£…ã‚’ä¸Šæ›¸ãã—ã¦`undefined`ã‚’è¿”ã™ãŸã‚ã§ã™ã€‚

[jest.spyOn ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://jestjs.io/docs/jest-object#jestspyonobject-methodname)ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã‚ã‚Šã¾ã™ã€‚
`spyOn`ã®æŒ™å‹•ãŒã‚€ã—ã‚ä¾‹å¤–çš„ãªã‚“ã§ã™ã­ã€‚

> By default, jest.spyOn also calls the spied method. This is different behavior from most other test libraries. If you want to overwrite the original function, you can use jest.spyOn(object, methodName).mockImplementation(() => customImplementation) or object[methodName] = jest.fn(() => customImplementation).

é•ã„ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ã€‚
ãƒ¢ãƒƒã‚¯ã—ã¦ã„ã‚‹æ„å‘³ã¯å…¨ç„¶ãªã„ã§ã™ãŒã€ã‚¤ãƒ¡ãƒ¼ã‚¸ãªã®ã§å¤§ç›®ã«è¦‹ã¦ãã ã•ã„ã€‚

```ts
// spyOn ã®ã¨ã
import * as sample from './sample'

test('sample test when spyOn', () => {
    const spied = jest.spyOn(sample, 'sampleFunc')
    expect(spied('spy')).toBe('this is spy')  // âœ… æˆåŠŸ
    expect(spied).toHaveBeenCalledWith('spy') // âœ… æˆåŠŸ
})


// mock ã®ã¨ã
import { sampleFunc } from './sample'

jest.mock('./sample') // sanpleFunc ã¯ () => undefined ã§ä¸Šæ›¸ã

test('sample test when mock', () => {
    const mocked = jest.mocked(sampleFunc)
    expect(mocked('mock')).toBe('this is mock') // âŒ å¤±æ•—
    expect(mocked).toHaveBeenCalledWith('mock') // âœ… æˆåŠŸ
})
```

ã“ã®æŒ™å‹•ã ã¨å›°ã£ã¦ã—ã¾ã†ãŸã‚ã€`jest.mock`ã®ç¬¬äºŒå¼•æ•°ã§ä¸Šæ›¸ãã™ã‚‹å†…å®¹ã‚’æ˜ç¤ºçš„ã«æŒ‡å®šã™ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒé€šã‚Šã¾ã™ã€‚

```ts
import { sampleFunc } from 'sample'

jest.mock('./sample', () => {
    const actual = jest.requireActual('./sample') // å®Ÿéš›ã®å®Ÿè£…ã‚’å–å¾—
    return {
        sampleFunc: jest.fn(actual.sampleFunc) // å®Ÿéš›ã®å®Ÿè£…ã‚’å‘¼ã¶
    }
})

test('sample test when mock', () => {
    const mocked = jest.mocked(sampleFunc)
    expect(mocked('mock')).toBe('this is mock') // âœ… æˆåŠŸ
    expect(mocked).toHaveBeenCalledWith('mock') // âœ… æˆåŠŸ
})
```

ä¸Šè¨˜ã®ä¾‹ã ã¨ 1 ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ 1 ã¤ã®é–¢æ•°ã—ã‹ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ãŒã€å®Ÿéš›ã«ã¯è¤‡æ•°ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹å ´åˆã‚„ã€ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰æä¾›ã•ã‚Œã‚‹é–¢æ•°ã®ã†ã¡ä¸€éƒ¨ã ã‘ãƒ¢ãƒƒã‚¯ã—ãŸã„å ´åˆã‚‚ã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãã†ã„ã£ãŸå ´åˆã«ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã¨è‰¯ã„ã§ã™ã€‚

```ts
jest.mock('./sample', () => {
    const actual = jest.requireActual('./sample')
    return {
        ...actual, // sampleFunc ä»¥å¤–ã¯ãã®ã¾ã¾
        sampleFunc: jest.fn(actual.sampleFunc)
    }
})
```

ã‚‚ã—`sample`ã«é–¢æ•°ãŒè¿½åŠ ã•ã‚Œã¦ã‚‚å½±éŸ¿ã‚’æŠ‘ãˆã‚‰ã‚Œã‚‹ã®ã§ã€å¸¸ã«`...actual`ã®ã‚ˆã†ã«ã—ã¦ãŠã„ã¦ã‚‚è‰¯ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

## ã¾ã¨ã‚

- ç§»è¡Œè‡ªä½“ã¯ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã¦`.swcrc`æ›¸ã‘ã°ã ã„ãŸã„å‹•ã
- `import * as ~`ã—ã¦ã‹ã‚‰`jest.spyOn`ã—ã¦ã„ã‚‹éƒ¨åˆ†ã¯`jest.mock`ã«ä¿®æ­£ã™ã‚‹
- `jest.spyOn`ã¨`jest.mock`ã®é•ã„ã‚’ç†è§£ã—ã¦ãªã„ã¨ãƒ€ãƒ¡

swc ã¨ã‹ã‚ã‚“ã¾ã‚Šé–¢ä¿‚ãªã„éƒ¨åˆ†ã§å››è‹¦å…«è‹¦ã—ã¦ã„ã¾ã—ãŸã€‚å®Œå…¨ã«åƒ•ã®å‹‰å¼·ä¸è¶³ã§ã—ãŸã€‚

## å‚è€ƒ

- [@swc/jest â€“ SWC][1]
- [@swc/jestã§æ‰‹é–“ã‚’ã‹ã‘ãšã«ãƒ†ã‚¹ãƒˆã‚’æ—©ãã™ã‚‹][2]
- [jest.spyOnã§TypeError: Cannot redefine property][3]
- [Jest Â· ğŸƒ Delightful JavaScript Testing][4]

[1]: https://swc.rs/docs/usage/jest
[2]: https://blog.nnn.dev/entry/2024/02/26/110000
[3]: https://qiita.com/nakazavva/items/a1552527ce54a53c5c88
[4]: https://jestjs.io/ja/